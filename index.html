<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Hike Shop</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
</head>
<body>

  <h1>The Hike Shop</h1>

  <!-- Collapsible Filter Panel -->
  <button id="filter-toggle">Show / Hide Filters</button>
  <div id="filter-panel" style="display:none; margin-bottom:20px; text-align:center;">
    <div>
      <label for="region-filter">Region:</label>
      <select id="region-filter">
        <option value="">All</option>
        <option value="North">North</option>
        <option value="Central">Central</option>
        <option value="South">South</option>
      </select>
    </div>
    <div>
      <label for="difficulty-filter">Difficulty:</label>
      <select id="difficulty-filter">
        <option value="">All</option>
        <option value="Easy">Easy</option>
        <option value="Moderate">Moderate</option>
        <option value="Hard">Hard</option>
        <option value="Strenuous">Strenuous</option>
      </select>
    </div>
    <div>
      <label>Features:</label>
      <div id="feature-filters" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:5px;">
        <label><input type="checkbox" value="waterfall"> Waterfall</label>
        <label><input type="checkbox" value="overlook_vista"> Overlook</label>
        <label><input type="checkbox" value="stream_crossing"> Stream Crossing</label>
        <label><input type="checkbox" value="rock_scramble"> Rock Scramble</label>
        <label><input type="checkbox" value="wildlife"> Wildlife</label>
        <label><input type="checkbox" value="historic"> Historic</label>
        <label><input type="checkbox" value="fall_foliage_favorite"> Fall Foliage</label>
        <label><input type="checkbox" value="permit"> Permit</label>
      </div>
    </div>
  </div>

  <!-- Search Bar -->
  <input type="text" id="search" placeholder="Search trails by name...">

  <!-- Trail Cards -->
  <div id="trail-list"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Leaflet GPX Plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.6.0/gpx.min.js"></script>
  <script>
    let trails = [];

    // DOM elements
    const trailList = document.getElementById('trail-list');
    const searchInput = document.getElementById('search');
    const regionFilter = document.getElementById('region-filter');
    const difficultyFilter = document.getElementById('difficulty-filter');
    const featureFilters = document.querySelectorAll('#feature-filters input[type="checkbox"]');

    // Load trails.json
    fetch('trails.json')
      .then(response => response.json())
      .then(data => {
        trails = data;
        displayTrails(trails);
      })
      .catch(err => console.error('Error loading trails.json:', err));

    // Display trails
    function displayTrails(list) {
      trailList.innerHTML = '';

      list.forEach(trail => {
        const card = document.createElement('div');
        card.className = 'trail-card';

        // Trail Name
        const header = document.createElement('h2');
        header.textContent = trail.trail_name || 'Unnamed Trail';
        header.style.textAlign = 'center';
        card.appendChild(header);

        // Map container
        const mapDiv = document.createElement('div');
        mapDiv.style.width = '100%';
        mapDiv.style.height = '200px';
        mapDiv.style.marginBottom = '10px';
        const mapId = 'map-' + Math.random().toString(36).substr(2, 9);
        mapDiv.id = mapId;
        card.appendChild(mapDiv);

        // Trail Info: Region, Difficulty, Length
        const info = document.createElement('p');
        info.textContent = `Region: ${trail.region || 'N/A'} | Difficulty: ${trail.difficulty || 'N/A'} | Length: ${trail.length_miles?.toFixed(1) || 'N/A'} miles`;
        info.style.textAlign = 'center';
        card.appendChild(info);

        // Feature Buttons
        const featuresDiv = document.createElement('div');
        featuresDiv.className = 'features';
        const featureKeys = ['waterfall','overlook_vista','stream_crossing','rock_scramble','wildlife','historic','fall_foliage_favorite','permit'];
        const activeFeatures = featureKeys.filter(f => trail[f]);

        const featureButton = document.createElement('button');
        featureButton.className = 'expand-btn';
        featureButton.textContent = activeFeatures.length > 0 ? 'Show Features' : 'No Features';
        featuresDiv.appendChild(featureButton);

        const featureList = document.createElement('div');
        featureList.className = 'feature-list';
        featureList.style.display = 'none';
        featureList.style.flexWrap = 'wrap';
        featureList.style.justifyContent = 'center';
        featureList.style.gap = '5px';

        activeFeatures.forEach(f => {
          const btn = document.createElement('button');
          btn.textContent = f.replace(/_/g, ' ');
          btn.className = 'feature-tag';
          featureList.appendChild(btn);
        });

        featuresDiv.appendChild(featureList);
        card.appendChild(featuresDiv);

        // Expand/collapse logic
        featureButton.addEventListener('click', () => {
          featureList.style.display = featureList.style.display === 'none' ? 'flex' : 'none';
          featureButton.textContent = featureList.style.display === 'none' ? 'Show Features' : 'Hide Features';
        });

        // Append card first so Leaflet can render properly
        trailList.appendChild(card);

        // Initialize map
        const lat = parseFloat(trail.trailhead_coordinates_latitude);
        const lng = parseFloat(trail.trailhead_coordinates_longitude);

        if (!isNaN(lat) && !isNaN(lng)) {
          requestAnimationFrame(() => {
            const map = L.map(mapId, { scrollWheelZoom: false }).setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Marker at trailhead
            L.marker([lat, lng]).addTo(map).bindPopup(trail.trail_name || '');

            // Load GPX if available
            if (trail.gpx_url) {
              new L.GPX(trail.gpx_url, {
                async: true,
                marker_options: {
                  startIconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                  endIconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
                }
              }).on('loaded', e => map.fitBounds(e.target.getBounds()))
              .addTo(map);
            }
          });
        } else {
          mapDiv.textContent = 'Map not available';
          mapDiv.style.display = 'flex';
          mapDiv.style.justifyContent = 'center';
          mapDiv.style.alignItems = 'center';
          mapDiv.style.color = '#333';
          mapDiv.style.fontWeight = 'bold';
          mapDiv.style.backgroundColor = '#c0c090';
          mapDiv.style.borderRadius = '5px';
        }
      });
    }

    // Apply filters
    function applyFilters() {
      let filtered = trails;

      // Search
      const term = searchInput.value.toLowerCase();
      if (term) {
        filtered = filtered.filter(t => t.trail_name && t.trail_name.toLowerCase().includes(term));
      }

      // Region
      const regionVal = regionFilter.value;
      if (regionVal) {
        filtered = filtered.filter(t => t.region === regionVal);
      }

      // Difficulty
      const difficultyVal = difficultyFilter.value;
      if (difficultyVal) {
        filtered = filtered.filter(t => t.difficulty === difficultyVal);
      }

      // Features
      const selectedFeatures = Array.from(featureFilters)
        .filter(f => f.checked)
        .map(f => f.value);

      if (selectedFeatures.length > 0) {
        filtered = filtered.filter(trail =>
          selectedFeatures.every(f => trail[f])
        );
      }

      displayTrails(filtered);
    }

    // Event listeners
    searchInput.addEventListener('input', applyFilters);
    regionFilter.addEventListener('change', applyFilters);
    difficultyFilter.addEventListener('change', applyFilters);
    featureFilters.forEach(f => f.addEventListener('change', applyFilters));

    // Filter toggle
    const filterToggle = document.getElementById('filter-toggle');
    const filterPanel = document.getElementById('filter-panel');
    filterToggle.addEventListener('click', () => {
      filterPanel.style.display = filterPanel.style.display === 'none' ? 'block' : 'none';
    });
  </script>

</body>
</html>
